name: End to End test

on:
  #workflow_dispatch: {}
  pull_request:
  push:
    branches:
      - main

jobs:
  test-chart:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        k8s:
          - v1.31.0
          - v1.32.0
          - v1.33.0
          - v1.34.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      # -------------------------------------------------------
      # Install Helm
      # -------------------------------------------------------
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      # -------------------------------------------------------
      # Install kind manually
      # -------------------------------------------------------
      - name: Install kind
        run: |
          KIND_VERSION="v0.30.0"
          curl -Lo kind https://kind.sigs.k8s.io/dl/$KIND_VERSION/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind

      # -------------------------------------------------------
      # Create cluster with specific Kubernetes version
      # -------------------------------------------------------
      - name: Create kind cluster
        run: |
          kind create cluster \
            --name test \
            --image "kindest/node:${{ matrix.k8s }}" \
            --wait 60s

          kubectl cluster-info
          kubectl get nodes

      # -------------------------------------------------------
      # Install Helm chart
      # -------------------------------------------------------
      - name: Install Helm chart
        continue-on-error: true
        env:
          ENTSOE_API_KEY: ${{ secrets.ENTSOE_API_KEY }}
        run: |
          cd chart
          helm dependency update
          helm upgrade --install caas-carbon-footprint . \
            --namespace caas --create-namespace \
            --set entsoe.entsoe_api_key="$ENTSOE_API_KEY" \
            --set entsoe.image.tag=latest \
            --wait --timeout 1m

      # -------------------------------------------------------
      # Wait until all pods are Ready
      # -------------------------------------------------------
      - name: Wait for pods to be ready
        continue-on-error: true
        run: |
          kubectl wait --for=condition=Ready pods --all -n caas --timeout=30s
          echo kubectl get pods -n caas
          kubectl get pods -n caas --show-labels
          echo kubectl get services -n caas
          kubectl get services -n caas

      # -------------------------------------------------------
      # Port-forward and Post-Install Curl Test
      # -------------------------------------------------------
      - name: Run Post-Install HTTP Check
        continue-on-error: true
        run: |
          # service name + port (adjust as needed)
          SERVICE=entsoe-caas-carbon-footprint
          PORT=80
          EXPECTED="entsoe_generation_b01"

          kubectl port-forward svc/$SERVICE -n caas 8080:$PORT >/tmp/pf.log 2>&1 &

          # Wait until the port-forward is up
          for i in {1..20}; do
            sleep 1
            curl -sf http://localhost:8080 && break
          done

          # test output
          #curl -v  http://localhost:8080/metrics
          #kubectl logs -l app.kubernetes.io/name=caas-carbon-footprint -n caas --tail=200 || true

          OUTPUT=$(curl -s http://localhost:8080/metrics)
          echo "Output: $OUTPUT"

          if [[ "$OUTPUT" != *"$EXPECTED"* ]]; then
            echo "❌ Expected output not found!"
            exit 1
          fi

          echo "✔ Output validated successfully"

      # -------------------------------------------------------
      # Debug info on failure
      # -------------------------------------------------------
      - name: Dump logs on failure
        if: failure()
        run: |
          kubectl get all -A
          kubectl describe pods -A
          kubectl logs -l app.kubernetes.io/name=caas-carbon-footprint -n caas --tail=200 || true

